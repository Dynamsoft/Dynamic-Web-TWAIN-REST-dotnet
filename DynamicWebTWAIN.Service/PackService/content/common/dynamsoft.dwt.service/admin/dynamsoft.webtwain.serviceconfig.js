/*! 20250313
* Dynamsoft WebTWAIN Admin Console
* Product: Dynamsoft Web Twain
* Web Site: http://www.dynamsoft.com
*
* Copyright 2025, Dynamsoft Corporation 
* Author: Dynamsoft Support Team
* Version: 1.05
*/
;var maxTry=10000,tryNum=0,buttonName="",bErr=false,localhost="127.0.0.1",lib=Dynamsoft.Lib,oldHost="",oldPort=-1,oldSSLPort=-1,oldEnablemDNSService=false,oldAlias="",oldTags="",bNeedReboot=true,clientId=lib.guid();if(location.host!="127.0.0.1:18625"){location.href="http://127.0.0.1:18625/"}function setLogLevel(a){if(dwtVers&&dwtVers.length>0){var b,d,c;b=lib.get("host").value;if(b==""){b=location.hostname}d=lib.get("port").value;lib.each(dwtVers,function(g){var e=["http://",b,":",d,"/fa/LogLevel?t=",Date.now].join(""),f={id:clientId,method:"LogLevel",module:"dwt",parameter:[a],version:g};lib.fetch(e,{method:"post",dataType:"json",body:lib.stringify(f)})})}}function ifNewDWTPortOK(){var a,d,b;a=lib.get("host").value;if(a==""){a=location.hostname}d=lib.get("port").value;b=lib.get("sslPort").value;if(d==b||d<=0||b<=0){return lib.Promise.resolve(false)}if(a==oldHost){if(parseInt(d)==parseInt(oldPort)){d=-1}if(parseInt(b)==parseInt(oldSSLPort)){b=-1}}else{if(a=="127.0.0.1"&&oldHost!="127.0.0.1"){if(parseInt(d)==parseInt(oldPort)){d=-1}if(parseInt(b)==parseInt(oldSSLPort)){b=-1}if(d==-1&&b==-1){return lib.Promise.resolve(true)}}}var c={id:clientId,method:"CheckDWTPort",parameter:[a,d,b,0,0],version:dcpVersion};lib.openMsg();lib.showMsg(-1,"","Checking ports...");return sendMsg(localhost,c).then(function(f){lib.closeMsg();bErr=false;if(f&&lib.isArray(f.result)){if(f.result[0]){showInfo("Successfully.",1000);return true}var e="The port is already in use.";showError(e)}return false},function(e){showError(e);lib.closeMsg();return false})}function getInfo(){var a={id:clientId,method:"GetServerInfo",parameter:[],version:dcpVersion};lib.openMsg();lib.showMsg(-1,"","Loading...");return sendMsg(localhost,a).then(function(b){lib.closeMsg();let valHost="127.0.0.1";if(b.Host!="*"&&b.Host!=""){valHost=b.Host}lib.get("host").value=valHost;lib.get("port").value=b.dwt.port;lib.get("sslPort").value=b.dwt.sslPort;oldHost=valHost;oldPort=b.dwt.port;oldSSLPort=b.dwt.sslPort;var c=lib.get("selectHost");c.value=valHost;buttonName="";bErr=false},function(){checkReboot()})}function innerSetServerInfo(){var c={id:clientId,method:"SetServerInfo",version:dcpVersion},d,b;var a=lib.get("host").value;if(a==""){a=location.hostname}buttonName="UPDATE";bErr=false;lib.openMsg();lib.showMsg(-1,"","Rebooting...");if(oldHost==a){return lib.Promise.resolve(true)}d=lib.get("port").value;b=lib.get("sslPort").value;c.parameter=[a,18625,18626,d,b];return sendMsg(localhost,c)}function updateFirewall(){var b={};var a=lib.get("ifAddToFirewall").checked;if(a){b={id:clientId,method:"AddFirewall",parameter:[1],version:dcpVersion}}else{b={id:clientId,method:"DeleteFirewall",parameter:[1],version:dcpVersion}}return sendMsg(localhost,b)}function innerSetMDNSService(){var b={id:clientId,method:"SetmDNSService",version:ddmVersion,cmdId:lib.guid()};var e=false,g=0,c="",j="",f=0,i=1,h=0,d=0,a="";buttonName="UPDATE";bErr=false;lib.openMsg();lib.showMsg(-1,"","Rebooting...");if(lib.get("ifEnabledBonjour").checked){e=true;c=lib.get("bonjourAlias").value;j=lib.get("bonjourTag").value;if(e==oldEnablemDNSService&&oldAlias==c&&oldTags==j){bNeedReboot=false;return lib.Promise.resolve(true)}}else{if(e==oldEnablemDNSService){bNeedReboot=false;return lib.Promise.resolve(true)}}b.parameter=[e,c,j,f,i,h,g,d,a];return sendDDM(localhost,b)}function updateCert(){var c=lib.get("sslCert").files,d;if(c.length>0){var a=c[0];var b=["http://127.0.0.1:18625/dcp/",dcpVersion,"/LoadZipFromBytes?type=4","&dsver=",dcpVersion,"&ts=",lib.now()].join("");d=lib.fetch(b,{method:"post",dataType:"json",body:a}).then(function(e){if(e&&e.description){throw e.description}showInfo("The SSL cert updated.");return true},function(e){throw"The SSL cert update failed."})}else{d=lib.Promise.resolve(true)}lib.get("sslCert").value="";return d}function onclick_setInfo(){clickedUpdateButton=true;lib.hide(lib.one(".ds-tips")[0]);var c,b;c=lib.get("port").value;b=lib.get("sslPort").value;if(c==b||c<=0||b<=0){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";if(c==b){lib.get("ds-msg").innerHTML="The Port is same as the SSL Port."}else{if(c<=0){lib.get("ds-msg").innerHTML="The Port is invalid."}else{if(b<=0){lib.get("ds-msg").innerHTML="The SSL Port is invalid."}}}return}var a=lib.get("host").value;if(lib.get("ifEnabledBonjour").checked){if(a.length<=0){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML="Host is required.";return}else{if(a==0){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML="Host is invalid.";return}else{if(a=="127.0.0.1"){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML='Host cannot set to "127.0.0.1".';return}else{if(a=="localhost"){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML='Host cannot set to "localhost".';return}}}}if(lib.get("bonjourAlias").value.length<=0){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML="Name is required.";return}else{if(lib.get("bonjourAlias").value.length>32){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML="The length of Name exceeds the maximum limit.";return}}if(lib.get("bonjourTag").value.length>128){lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML="The length of Tag exceeds the maximum limit.";return}}updateCert().then(function(){return innerSetMDNSService()}).then(function(e){if(e){return innerSetServerInfo()}else{var d="Failed to set Bonjour Service.";lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML=d;throw d}}).then(function(){return updateFirewall()}).then(function(d){return _reboot_inner(localhost)},function(d){lib.forceCloseMsg();bErr=true;lib.error(d);showError(d)}).then(function(){oldHost=lib.get("host").value;oldEnablemDNSService=lib.get("ifEnabledBonjour").checked;oldAlias=lib.get("bonjourAlias").value;oldTags=lib.get("bonjourTag").value;bNeedReboot=true})}function _reboot_inner(b){var c={id:clientId,method:"Reboot",parameter:[],version:dcpVersion};tryNum=0;var a=lib.get("host").value;if(oldHost==a&&!bNeedReboot){lib.forceCloseMsg();lib.show(lib.one(".ds-tips")[0]);lib.one(".ds-tips")[0].className="ds-tips";lib.get("ds-msg").innerHTML=[buttonName," ","SUCCESSFULLY!"].join("");return lib.Promise.resolve(true)}return sendMsg(b,c).then(makesureServiceRestarted,makesureServiceRestarted)}function makesureServiceStopped(a){let retries=600;let retryDelay=50;return new Promise(function(e,d){const c=function(f){return Dynamsoft.Lib.fetch(a,{method:"post",fetchRaw:true,timeout:50}).then(function(g){if(f<retries){b(f)}else{d(false)}}).catch(function(g){e(true)})};function b(f){setTimeout(function(){c(++f)},retryDelay)}return c(0)})}function makesureServiceRestarted(){return makesureServiceStopped(location.href).then(checkReboot,checkReboot)}function checkReboot(){var a={id:clientId,method:"GetServerInfo",parameter:[],version:dcpVersion};return sendMsg(host,a).then(function(b){lib.forceCloseMsg();lib.get("port").value=b.dwt.port;lib.get("sslPort").value=b.dwt.sslPort;oldPort=b.dwt.port;oldSSLPort=b.dwt.sslPort;if(buttonName==""){lib.hide(lib.one(".ds-tips")[0])}else{lib.show(lib.one(".ds-tips")[0]);if(bErr){lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML=[buttonName," ","FAILED!"].join("")}else{lib.one(".ds-tips")[0].className="ds-tips";lib.get("ds-msg").innerHTML=[buttonName," ","SUCCESSFULLY!"].join("")}setTimeout(function(){lib.hide(lib.one(".ds-tips")[0])},3000)}},function(){tryNum++;if(tryNum>maxTry){if(buttonName==""){lib.hide(lib.one(".ds-tips")[0])}else{lib.show(lib.one(".ds-tips")[0]);if(buttonName=="UPDATE"&&!bErr){lib.one(".ds-tips")[0].className="ds-tips";lib.get("ds-msg").innerHTML=[buttonName," ","SUCCESSFULLY!"].join("")}else{lib.one(".ds-tips")[0].className="ds-tips ds-error";lib.get("ds-msg").innerHTML=[buttonName," ","FAILED!"].join("")}setTimeout(function(){lib.hide(lib.one(".ds-tips")[0])},3000)}lib.showMsg(-1,"","Get Server Info Error.");return}setTimeout(checkReboot,300)})}function refreshLogLevel(){var a=lib.get("srcLogLevel").value;if(a=="14"){lib.get("divLog").innerHTML="On"}else{lib.get("srcLogLevel").value="0";lib.get("divLog").innerHTML="Off"}}function switchLogLevel(){var b=lib.get("srcLogLevel").value,a;if(b=="14"){a=0;lib.get("srcLogLevel").value="0"}else{a=14;lib.get("srcLogLevel").value="14"}setLogLevel(a);refreshLogLevel()}function initBonjour(){var a=lib.get("ifEnabledBonjour");a.checked=false;a.onclick=refreshBonjourContent;getmDNSService()}function refreshBonjourContent(){lib.log("ifEnabledBonjour changed");var a=lib.get("ifEnabledBonjour");var b=[];b.push(lib.get("bonjourAlias"));b.push(lib.get("bonjourTag"));if(!!a.checked){lib.each(b,function(c,d){c.disabled=""});lib.get("ifAddToFirewall").checked=true;lib.get("ifAddToFirewall").disabled=true;lib.get("bonjourAlias").disabled=false;lib.get("bonjourTag").disabled=false}else{lib.each(b,function(c,d){c.disabled="disabled"});lib.get("allowAccessScanner").checked="checked";lib.get("ifAddToFirewall").disabled=false;lib.get("ifAddToFirewall").checked=false;lib.get("bonjourAlias").value="";lib.get("bonjourAlias").disabled=true;lib.get("bonjourTag").value="";lib.get("bonjourTag").disabled=true}}function getmDNSService(){var a={id:clientId,cmdId:lib.guid(),method:"GetmDNSService",parameter:[],version:ddmVersion};lib.openMsg();lib.showMsg(-1,"","Loading...");return sendDDM(localhost,a).then(function(c){lib.closeMsg();var d=0;var b=dm_parseResultDefault(c);if(b&&lib.isArray(b)&&b.length>4){oldEnablemDNSService=b[0];d=b[1];oldAlias=b[2];oldTags=b[3];lib.get("bonjourAlias").value=oldAlias;if(oldEnablemDNSService){lib.get("ifEnabledBonjour").checked="checked";lib.get("bonjourTag").value=oldTags}else{lib.get("ifEnabledBonjour").checked=false;lib.get("bonjourTag").value=""}refreshBonjourContent()}bErr=false},function(){lib.closeMsg()})}function initSelectHost(){lib.openMsg();lib.showMsg(-1,"","Get Local IP...");return getLocalIP().then(function(b){lib.closeMsg();if(lib.isArray(b)){var a=lib.get("selectHost");a.options.length=0;var c=new Option(localhost,localhost);a.appendChild(c);lib.each(b,function(e){var d=new Option(e,e);a.appendChild(d)});a.onchange=function(d){var e=lib.get("host");e.value=d.target.value};bErr=false}else{if(b.description){let err=b.description;lib.error(err);bErr=true;showError(err)}}},function(a){lib.closeMsg()})}lib.domReady(function(){lib.one(".main").style("height",(screen.height-200)+"px");refreshLogLevel();initBonjour();initSelectHost();getInfo();lib.addEventListener(lib.get("update"),"click",onclick_setInfo)});